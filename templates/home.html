{% extends "base.html" %}

{% block content %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul>
        {% for category, message in messages %}
          <li class="flash-msg" data-category="{{ category }}"> {{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
  <div class="d-flex">
    <aside>
      <div class="aside-container">
        <a href="/" >
          <div class="aside--items">
            Create New +
          </div>
        </a>

        <a href="/">
          <div class="aside--items">
            Dashboard
          </div>
        </a>

        <a href={{ url_for("url.generate_qrcode") }}>
          <div class="aside--items">
            QR Codes
          </div>
        </a>

        <a href={{ url_for("url.user_history") }}>
          <div class="aside--items">
            History
          </div>
        </a>

        {% if current_user.is_authenticated %}
          <a href={{ url_for("accounts.account_settings") }}>
            <div class="aside--items">
              Account Settings
            </div>
          </a>
        {% endif %}

        {% if current_user.is_authenticated %}
          <form class="aside--button" action="{{ url_for("accounts.log_out") }}" method="post">
            <button class="">Log Out</button>
          </form>
        {% else %}

          <a class="" href={{ url_for("accounts.log_in") }}>
            <div class="aside--items--login">
              Log In
            </div>
          </a>

          <a class="" href={{ url_for("accounts.sign_up") }}>
            <div class="aside--items--signup">
              Sign Up
            </div>
          </a>
        {% endif %}
      </div>
    </aside>
    {% block main %}
      <div class="text-center main-content d-flex flex-column align-items-center">
        <h4 class="header">TRM URL</h4>
        <form action="" method="post" class="m-4 py-4 main-form">
          <div class="d-flex gap-2 form-main">
            <input class="d-inline" type="url" name="long_url" id="URLInput" required placeholder="Enter a long URL">
            <button class="icon" onclick="pasteFromClipboard()">
              <img src="/static/images/paste-preview.png" alt="" height="20" width="20">
            </button>
            <button class="icon clear" onclick="clearInput()">
              <img src="/static/images/clear-white.svg" alt="" height="20" width="20">
            </button>
          </div>
          <div>
            {% if current_user.is_authenticated %}
              <input class="my-4" type="text" name="custom_half" id="custom_url" placeholder="Add custom half e.g. trmmr.me/your-custom-half (Optional)" size="60">
            {% endif %}
            <div>
              <button type="submit" class="main-button">
                <img src="/static/images/scissors-landscape.svg" alt="" width="30" height="24">
                TRM
              </button>
            </div>
          </div>
        </form>
        <div class="mt-4">
          {% if short_url %}
            <div>
              <code class="code">
               <span id="url-text">{{ short_url }}</span>
              <button class="copy-btn px-2 py-0" onclick="copyToClipboard('{{ short_url }}')">
                <img src="/static/images/clippy.svg" alt="" height="20" width="20">
              </button></code>
            </div>
            {% if current_user.is_authenticated  %}
              <div id="target" class="">
                <button class="form-btn mt-0" hx-post="{{ url_for('url.generate_qrcode', url=short_url) }}"
                        hx-target="#target">Generate QR code</button>
              </div>
              <div id="pwd-container">
                <form action="{{ url_for('url.set_url_password', unique_id=short_url.split('/')[-1]) }}" method="post" class="my-5 mx-auto" id="pwd-form">
                  <button class="form-btn" onclick="addPasswordForm()">Secure URL</button>
                </form>
              </div>
            {% endif %}
          {% elif current_user.is_authenticated and last_shortened_url %}
            <div class="last-short">
              <h5>Recently TRMMD</h5>
              <div class="m-auto py-3">
                <p>
                  <b></b> <a class="mx-4 font-small" href="{{ last_shortened_url.short_url }}">{{ last_shortened_url.short_url }}</a>
                  <span class="bubble">{{ last_shortened_url.get_total_clicks() }} Clicks</span><br>
                </p>
                Original URL: <a href="{{ last_shortened_url.original_url }}" class="justlink text-small">
                  {{ last_shortened_url.original_url[0:70] }}...
                </a><br>
                <a class="m-1 p-1 float-end" href="{{ url_for('url.url_analytics', unique_id=last_shortened_url.unique_id) }}">
                  View analytics ->
                </a>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    {% endblock main %}
  </div>
{% endblock %}